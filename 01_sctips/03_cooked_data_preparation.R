# Data preparation ----



# 0. Prepare environme
source("01_sctips/00_utils.R")


# 0. load information ----

## 0.1. Informed consent ----
a0_students_consent <-
  read_sheet(
    ss = data_lake,
    sheet = "00c_raw_student_consent") %>% 
    as.data.frame() %>%  rename(ID_estudiante = Número) %>% 
  mutate(ID_estudiante = as.character(ID_estudiante))

## 0.2. Data dictionary 
b0_dictionary <- read.csv(
  "00_basic_data/0. Diccionario de variables.csv",
  header = T)

## 0.2. Surveys ----
c0_raw_sourvey <- read_sheet(
  "https://docs.google.com/spreadsheets/d/12Y2I-DBsfwJPKXRQvZ730ALZKfv2OcQjI8dxisFHxqY/edit?usp=sharing") %>% 
  # Initial editions
  mutate(Timestamp = as.Date(as.character(Timestamp))) %>% 
  select(-82,-93,-107,-114,-118,-122,-123,-146,-158,-162,-163,-164,-165,-166,-167) %>% 
  mutate(across(c(3,5,7,23,25,33,42,86,87,93,114,117,118,137),~as.character(.))) %>% 
  as.data.frame() %>% 
  # Correcting formats
  mutate(across(c(13,14,115),~as.character(.)),
         across(c(16,119),~as.Date(.)))
  
### renaming variables
names(c0_raw_sourvey) <- b0_dictionary[,2]

### Export to the datalake
write_sheet(
  c0_raw_sourvey,
  ss = data_lake,
  sheet = "01_raw_data")


# DATA CLIANING -----


# 1. Informed concent ----

## 1.1. Re-strucring data ----
a1_students_consent <- a0_students_consent %>% 
  ### data transposition
  select(Timestamp,
        id_student = ID_estudiante,
        q1 = `Manifiesto que _______ participar de manear voluntaria en el ejercicio de recolección de encuestas del proyecto en cuestión`,
        q2 = `Del mismo modo, reconozco que _________ recibí una capacitación por parte del equipo investigador, sobre la voluntariedad de las personas a encuestar por participar en la encuesta, la reserva de datos sensibles y sobre la importancia ética de no encuestar personas directamente subordinadas a mi o a mi núcleo familiar, de manera laboral o económica.`,
        q3 = `Por otro lado, expreso que (de ser posible) ___________ interés en ser coautor/a de la base de datos recolectada en este ejercicio, como un producto académico/científico público, independiente de las públicaciones que con ella se hagan.`,
        q4 = `Señalo tambien, que el grupo investigador _______ en cuanto al carácter voluntario de este ejercicio y el alcance del mismo.`,
        q5 = `Finalmente, ____________  a manejar todos los datos reportados por l@s encuestad@s en estricta confidencialidad, bajo la reserva del ejercicio de investigación y en cumplimiento con las directrices legales e institucionales de protección de datos.`) %>% 
  pivot_longer(cols = 3:7,
               names_to = "q") %>%
  ### Sumarizing questions
  mutate(
    value = str_detect(tolower(value),"no")==F,
    q_description = case_when(
      q=="q1"~"Q1. Wants to participate voluntarly",
      q=="q2"~"Q2. Claims to have received training",
      q=="q3"~"Q3. Wants to recive credit for\nthe data collection",
      q=="q4"~"Q4. Claims that the researchers\nwere clear regarding the voluntary\nnature of the exercise",
      T~"Q5. Agrees to keep the confidentiality\nof the data collected")) %>% 
  ### Determing students are valid interviwers 
  merge(
    (.[] %>% 
       filter(q != "q3") %>% # q3 is exluded for determinig this since its nor related to the protocol's complieance
       group_by(id_student) %>% 
       summarise(collection_agreement = mean(value)==1)),
    by = "id_student") %>% 
  ### Reroganizing data
  select(Timestamp, id_student, collection_agreement, q, q_description, value) %>% 
  mutate(value = ifelse(value ==T,"Yes","No"))

### 1.2. Report plot ----
a1_students_consent %>% 
  group_by(q_description,value) %>% 
  summarise(n = n()) %>% 
  arrange(desc(value)) %>% 
  group_by(q_description) %>%
  mutate(tot = sum(n),
         lugar = (cumsum(n)-n)+(n/2),
         texto =  paste0(n,"  (",round((n/tot)*100,1),"%)")) %>% 
  # Plot
  ggplot(aes(n,q_description, fill = value)) + 
  geom_bar(stat = "identity", alpha = .8)+
  geom_text(aes(lugar-10,q_description,label =texto),
            family = "serif",size = 3, color = "white")+
  scale_fill_manual(values = c("firebrick3","deepskyblue4"))+
  theme_minimal()+
  theme(text = element_text(family = "serif"),
        legend.position = "bottom")+
  labs(y = "The student ...",fill = "")

# save on drive
ggdrive_save(figures_drive,"000_students_informed_consent.png",h = 4,w= 6)


## 1.3. Validated interviwers ----
valid_interviewers <- a1_students_consent %>% 
  group_by(id_student) %>% 
  summarise(collection_agreement = max(collection_agreement)) %>% 
  filter(collection_agreement == 1) %>% 
  pull(id_student)

## 1.4. Final anonimized students informed consent database ----
a2_students_consent <- a1_students_consent %>% 
  select(-q) %>% 
  pivot_wider(names_from = q_description,
              values_from = value) %>% 
  mutate(id_student = row_number()) 
  


# 2. Data dictionary ----

## 2.1. Detect variables by respondent type ----
z0_test <- c0_raw_sourvey %>% 
  group_by(TI01_tipo) %>% 
  summarise(across(everything(),~mean(!is.na(.)))) %>% 
  reshape2::melt(id.vars = "TI01_tipo") %>% 
  group_by(TI01_tipo) %>% 
  mutate(index = row_number(),
         index = ifelse(index >=8,index+1,index),
         value = ifelse(
           value>0.1,paste0(
             "x (", round(value,2),")"),"")) %>% 
  pivot_wider(id_cols = c(index,variable),
              names_from = TI01_tipo,
              values_from = value)

## 2.2. Add information to the dictionary ----
b1_dictionary <- b0_dictionary %>% 
  merge(z0_test %>% select(-variable),
        by = "index", all.x = T) %>% 
  mutate(across(5:9, ~ifelse(is.na(.),"x (1)",.)))



# 3. Remove Surveys ----
## 3.1. Remotion ----
c1_surveys <- c0_raw_sourvey %>% 
  filter(
    # Remove surveys with an unvalidated interviewer
    ID_estudiante %in% valid_interviewers,
    # Remove surveys where the interviwer is the same as the respondent
    ID_estudiante != ID_empleador,
    ID_estudiante != ID_trabajador,
    # Remove surveys where the interviwer had a working relation wiht the respondent
    TI02_relacion_estudiante_encuestado != "RH - Tiene un relacion laboral conmigo o mi nucleo familiar (hogar)"|
     is.na(TI02_relacion_estudiante_encuestado))

## 3.2. Report ----
c1_surveys %>% 
  group_by(TI02_relacion_estudiante_encuestado) %>% 
  summarise(n = n())

  

## .1. Preparing data-lake (sheets/tables)
googlesheets4::sheet_add(
  ss = data_lake, 
  sheet = "00_data_dictionary")

googlesheets4::sheet_add(
  ss = data_lake, 
  sheet = "02_cooked_data")

googlesheets4::sheet_add(
  ss = data_lake, 
  sheet = "04_students_consent")


## 2. Writing data
googlesheets4::write_sheet(
  data = b1_dictionary,
  ss = data_lake,
  sheet = "00_original_data_dictionary")


googlesheets4::write_sheet(
  data = a2_students_consent,
  ss = data_lake,
  sheet = "04_students_consent")

googlesheets4::write_sheet(
  data = c1_surveys,
  ss = data_lake,
  sheet = "02_cooked_data")









