# Tasty data preparation


# 0. Prepare environment ----
source("01_sctips/00_utils.R")

# 1. Load data ----

## 1.1. Cooked data ----
a0_cooked <- read_sheet(
  ss = data_lake,
  sheet = "02_cooked_data")

## 1.2. Cooked dictionary ----
z0_dictionary <- 
  read_sheet(
    ss = data_lake,
    sheet = "00b_cooked_data_dictionary")

  



# 3. Table diferenciation ----
## 3.2. Workers ----
b0_wrokers <- a0_cooked %>% 
  ### Filter just empoyers
  filter(TI01_tipo != "BS - Empleador/a") %>% 
  ### Select employers' variables
  select(z0_dictionary$index[z0_dictionary$workers==T]) %>%
  ### Reset names with the dictionary
  setNames(z0_dictionary$final_worker[z0_dictionary$workers==T]) %>% 
  ### Add workers' age
  mutate(wd03_age = round((as.Date(sm01_capture_date)-as.Date(wd02_birth_date))/365, 0),
         wd03_age = ifelse(wd03_age >100,NA,wd03_age)) %>% 
  
  ### Reorder variables
  select(
    starts_with(c(
      # Survey metadata
      paste0("sm",str_pad(paste0(0:20),2, pad = "0")),
      # Identification
      paste0("id",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' information
      paste0("wi",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' demographics
      paste0("wd",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' economics
      paste0("we",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' finance
      paste0("wf",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' social mobility
      paste0("wm",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' discrimination
      paste0("dw",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' opinions
      paste0("wo",str_pad(paste0(0:20),2, pad = "0")),
      # Willines to pay
      paste0("wp",str_pad(paste0(0:20),2, pad = "0")),
      # Working Conditions
      paste0("wc",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' rights
      paste0("wr",str_pad(paste0(0:20),2, pad = "0")),
      # Workers' knlowledge
      paste0("wk",str_pad(paste0(0:20),2, pad = "0")))),
    everything())

## 3.2. Employers cooked ----
c0_employers <- a0_cooked %>% 
  ### Filter just empoyers
  filter(TI01_tipo == "BS - Empleador/a") %>% 
  ### Select employers' variables
  select(z0_dictionary$index[z0_dictionary$employers==T]) %>%
  ### Reset names with the dictionary
  setNames(z0_dictionary$final_employer[z0_dictionary$employers==T]) %>% 
  ### Add workers' age
  mutate(ed03_age = round((as.Date(sm01_capture_date)-as.Date(ed02_birth_date))/365, 0),
           ed03_age = ifelse(ed03_age >100,NA,ed03_age)) %>% 
  ### Integrate address
  
  ### Reorder variables
  select(
    starts_with(c(
      # Survey metadata
      paste0("sm",str_pad(paste0(0:20),2, pad = "0")),
      # Identification
      paste0("id",str_pad(paste0(0:20),2, pad = "0")),
      # Employer information
      paste0("ei",str_pad(paste0(0:20),2, pad = "0")),
      # Employer demographics
      paste0("ed",str_pad(paste0(0:20),2, pad = "0")),
      # Employer economics
      paste0("ee",str_pad(paste0(0:20),2, pad = "0")),
      # Willines to pay
      paste0("wp",str_pad(paste0(0:20),2, pad = "0")),
      # Employer knlowledge
      paste0("ek",str_pad(paste0(0:20),2, pad = "0")))),
      everything())

  
  
names(c0_employers)


##############

pr <- b0_wrokers %>% 
    mutate(
      wi03_address = paste(
        wi03_adress_1,wi03_adress_2,wi03_adress_3,wi03_adress_4,
        wi03_adress_5,wi03_adress_6, wi03_adress_7,sep = " "),
      wi03_address = str_remove_all(wi03_address, "Sin aditivo")) %>% 
  # select(wi03_address, !wi03_adress_1:wi03_adress_7)
  select(wi03_address, !starts_with("wi03")) 
  # select(wi03_address)
  

