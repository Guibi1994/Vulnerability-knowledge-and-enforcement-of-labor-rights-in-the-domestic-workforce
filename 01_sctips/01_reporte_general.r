# 0. Librerias, funciones y opciones:
library(bigrquery)
library(dplyr)
library(ggplot2)
library(googlesheets4)
library(stargazer)
'%!in%' <- function(x,y)!('%in%'(x,y))
simplyTEXT <- function(texto) {
  texto <- tolower(texto)
  texto <- gsub(pattern = "\ ", replacement = "",texto)
  texto <- gsub(pattern = "?", replacement = "a",texto)
  texto <- gsub(pattern = "?", replacement = "e",texto)
  texto <- gsub(pattern = "?", replacement = "i",texto)
  texto <- gsub(pattern = "?", replacement = "o",texto)
  texto <- gsub(pattern = "?", replacement = "u",texto)
  texto <- gsub(pattern = "?", replacement = "u",texto)
  texto <- gsub(pattern = "?", replacement = "u",texto)
  texto <- gsub(pattern = "?", replacement = "n",texto)
  return(texto)
}


options(scipen = 10)
setwd("C:\\Users\\guibo\\Desktop\\Trabajadoras dom?sticas")





# 1. Cargue de informaci?n ----
## 1.1. Encuestas ----
A1_encuestas <-
  read_sheet("https://docs.google.com/spreadsheets/d/12Y2I-DBsfwJPKXRQvZ730ALZKfv2OcQjI8dxisFHxqY/edit?usp=sharing") %>% 
  as.data.frame() %>%
  ### I. Arreglos Iniciales ----
  #### I.1. Cambiar listas por variables
  mutate(across(where(is.list),~(as.character(.))))  %>% 
  #### I.2. Cambiar foramto de fechas
  mutate(Timestamp = as.character(Timestamp),
         `PR02_fecha_nacimiento: Fecha de nacimiento` =
                    as.character(`PR02_fecha_nacimiento: Fecha de nacimiento`),
         `EM01_fecha_nacimiento_empleador: Fecha de nacimiento del empleador` =
                    as.character(`EM01_fecha_nacimiento_empleador: Fecha de nacimiento del empleador`)) %>% 
  #### I.3. Eliminaci?n de variables incosistentes
  select(-82, -93, -107, -114, -118, -122, -123, 
         -146, -158, -162,-163, -164, -165, -166, -167) %>% 
  
  ### I.4. Rectificaci?n de ID como n?mero
  mutate(`XX03: Documento del estudiante/encuestador` = as.numeric(`XX03: Documento del estudiante/encuestador`),
         `EM00_IDa_empleador: N?mero de documento`=as.numeric(`EM00_IDa_empleador: N?mero de documento`),
         `EM01_IDb_empleado: N?mero de documento de el/la trabajador/a dom?stica` = 
           as.numeric(`EM01_IDb_empleado: N?mero de documento de el/la trabajador/a dom?stica`),
         `EM01_IDb_empleado_R: Rectifique el documento n?mero de el/la trabajador/a dom?stica` = 
           as.numeric(`EM01_IDb_empleado_R: Rectifique el documento n?mero de el/la trabajador/a dom?stica`),
         `PR00a_numero_ID: N?mero de documento` = as.numeric(`PR00a_numero_ID: N?mero de documento`),
         `PR00b_numero_ID: Rectifique el n?mero de documento` = 
           as.numeric(`PR00b_numero_ID: Rectifique el n?mero de documento`)) %>% 
  
  ### II. Casos puntuales ----
  ####. II.1. Sofia Cruz Gomez
  mutate(`XX03: Documento del estudiante/encuestador` =
           ifelse(`XX03: Documento del estudiante/encuestador` == 1183422237, 1193422237,
                  `XX03: Documento del estudiante/encuestador`)) %>% 
  ####. II.2. Miguel Rincon
  mutate(`XX03: Documento del estudiante/encuestador` =
           ifelse(`XX03: Documento del estudiante/encuestador` %in% c(12,17), 1072673149,
                  `XX03: Documento del estudiante/encuestador`)) %>% 
  ####. II.3. Sara Cadena
  mutate(`XX03: Documento del estudiante/encuestador` =
           ifelse(`XX03: Documento del estudiante/encuestador` == 7, 1001196651,
                  `XX03: Documento del estudiante/encuestador`)) %>% 
  ####. II.4. Vanessa Panizza
  mutate(
    `EM01_IDb_empleado: N?mero de documento de el/la trabajador/a dom?stica` = 
      ifelse(`EM00_IDa_empleador: N?mero de documento` == 1018431219,1024549625,
             `EM01_IDb_empleado: N?mero de documento de el/la trabajador/a dom?stica`),
    `EM01_IDb_empleado_R: Rectifique el documento n?mero de el/la trabajador/a dom?stica` = 
      ifelse(`EM00_IDa_empleador: N?mero de documento` == 1018431219,1024549625,
             `EM01_IDb_empleado: N?mero de documento de el/la trabajador/a dom?stica`),
    `XX04: Clase` = ifelse(`XX03: Documento del estudiante/encuestador` == 1047499698,
                           "Derecho Colectivo del Trabajo",`XX04: Clase`)) %>% 
  ####. II.5. Casos de dos encuestas en una (an?malos)
  mutate(`EM00_IDa_empleador: N?mero de documento` =
           ifelse(!is.na(`EM00_IDa_empleador: N?mero de documento`) &
                    `TI01_tipo: Qu? tipo de sujeto va a encuestar`!="BS - Empleador/a",
                  NA,`EM00_IDa_empleador: N?mero de documento`),
         across(`EM01_IDb_empleado: N?mero de documento de el/la trabajador/a dom?stica`:
                  `EM01_IDb_empleado_R: Rectifique el documento n?mero de el/la trabajador/a dom?stica`,
                ~ifelse(!is.na(.) &
                          `TI01_tipo: Qu? tipo de sujeto va a encuestar`!="BS - Empleador/a",
                        NA,.),)) 



 ### III. Renombrar variables ----
names(A1_encuestas) <-  read.csv(
  "1. Bases de datos/0. Diccionario de variables.csv",
  header = T)[,2]




## 1.2. Concentimientos informados - Estudiantes ----
A2_concentiminetos <- 
  read_sheet("https://docs.google.com/spreadsheets/d/1uc-MTzZFepJTckFBi94NJhHwPayV-C3ETlWpDMXThxk/edit?usp=sharing") %>% 
  as.data.frame()



# 2. Reporte ----
pr_encuestados = A1_encuestas %>% select(ID_trabajador,ID_estudiante)
  
  
  
Reporte <- A1_encuestas %>% 
  mutate(ID_agregados = ifelse(is.na(ID_trabajador),ID_empleador,ID_trabajador),
         Empleadores = ifelse(TI01_tipo == "BS - Empleador/a",1,0)) %>% 
  ## 2.1. Identificai?n de errores ----
  
  ### 2.1.1. Identificaci?n de repetidos ----   
  group_by(ID_agregados) %>% 
  mutate(ID_repetido = ifelse(n()>1,1,0)) %>% 
  ungroup() %>% as.data.frame() %>% 
  
  ### 2.1.2. Idetificaci?n de ID trabajador incongruentes ----
  mutate(ID_trabajador_dif = ifelse(ID_trabajador != ID_trabajador_R,1,0)) %>% 
  
  ### 2.1.3. Identificaci?n ID empleadores homologados ----
  mutate(ID_homologado = ifelse(!is.na(ID_subordinado) &
    ID_subordinado %in% A1_encuestas$ID_trabajador,1,0)) %>% 
  
  ### 2.1.4. Identificaci?n Estudiante encuesta Esutiante
  mutate(Ecuesta_estudiante = 
           ifelse(!is.na(ID_empleador) &
                    ID_empleador %in% A1_encuestas$ID_estudiante,1,0)) %>% 
  
  ## 2.2. Agrupacion por estudiante y clase
  group_by(ID_estudiante, clase = estu_clase) %>% 
  summarise(Apellidos = first(estu_apellidos),
            Nombres = first(estu_nombre),
            Encuestas = n(),
            Empleadores = sum(Empleadores,na.rm = T),
            across(ID_repetido:Ecuesta_estudiante,~sum(.,na.rm = T))) %>% 
  as.data.frame()  %>% 
  arrange(clase, ID_estudiante) %>% 
  
  ## 2.3. Calculo de nota final
  mutate(Nota.Inicial = (((Encuestas-ID_repetido-Ecuesta_estudiante)*(5/6))-((5/6)*2))+
           ID_homologado*(5/6),
         
         Bonus = ifelse(Nota.Inicial>6,1,0),
         Nota.Inicial = ifelse(Nota.Inicial <0,0,
                             ifelse(Nota.Inicial>5,5,Nota.Inicial))) %>% 
  ## 2.4. Estudiantes en las dos clases
  group_by(ID_estudiante) %>% 
  mutate(Nota.Final = max(Nota.Inicial),
         Bonus = max(Bonus)) %>% 
  as.data.frame() %>% 
  
  ## 2.3. Concentimineto informado
  mutate(Firmo.Concentimiento = ifelse(ID_estudiante %in% 
                                         A2_concentiminetos$N?mero,"Si","No"),
         clase = ifelse(grepl("Cole",clase) ==T,"Colectivo","Seg. Social"))




# 3. Base Final de an?lisis

A3_Base_FInal <- A1_encuestas %>% 
  # Crear ID agregados
  mutate(ID_agregados = ifelse(is.na(ID_trabajador),ID_empleador,ID_trabajador)) %>% 
  distinct(ID_agregados,.keep_all = T) %>% 
  # Encuestas invlidas (Estudiante VS Estudiante)
  mutate(Ecuesta_estudiante = 
           ifelse(!is.na(ID_empleador) &
                    ID_empleador %in% A1_encuestas$ID_estudiante,1,0)) %>% 
  filter(Ecuesta_estudiante == 0) %>% 
  # Identificaic?n Homologados
  mutate(ID_homologado = 
           ifelse(!is.na(ID_subordinado) &
                    ID_subordinado %in% A1_encuestas$ID_trabajador,1,0)) %>% 
  # Agrupaci?n de direcci?n
  mutate(Final.adress = gsub("Sin aditivo","",paste(Adress.1,Adiress.2,Adress.3,Adress.4,
                               Adress.5,Adress.6,Adress.7," ")),
         Municipio = substr(simplyTEXT(Municipio),1,4),
         Fecha_captura = as.Date(substr(Fecha_captura,1,10)),
         PP00_pago_dia = 1000*PP00_pago_dia) %>% 
  select(!starts_with("Ad")) %>% 
  filter(Fecha_captura >= as.Date("2022-04-12"))









A3_Base_FInal %>% group_by(Fecha_captura) %>% 
  summarise(encuestas = n()) %>% as.data.frame() %>% 
  mutate(acumulado = cumsum(encuestas)) %>% 
  ggplot(aes(Fecha_captura,acumulado))+
  geom_path(color = "cyan4")+
  geom_point(color = "brown") +
  labs(title = "Evoluci?n del levantamiento de encuestas",
       x = "Fecha de captura",
       y = "Total encuestas a la fecha")+
  theme_minimal()+
  theme(text = element_text(family = "serif"),
        plot.title = 
          element_text(hjust = 0.5))

  
A3_Base_FInal %>% ggplot(aes(PP00_pago_dia, TI01_tipo))+
  geom_boxplot(color = "cyan4") +
  scale_x_continuous(labels = scales::dollar_format(),
                     breaks = scales::pretty_breaks(n = 6))+
  geom_vline(xintercept = mean(A3_Base_FInal$PP00_pago_dia,na.rm = T),
             color = "brown",lty = 2)+
  stat_summary(fun.x = mean, geom = "point",
               shape = 20, size = 4, color = "cyan3")+
  labs(title = "?Cu?l es el 'pago justo' por un d?a trabajo dom?stico?",
       x = "Pesos colombianos-COP",y ="",
       caption = "[---] Promedio general")+
  theme_minimal()+
  theme(text = element_text(family = "serif"),
        plot.title = element_text(hjust = 0.5))


A3_Base_FInal %>% filter(TI01_tipo != "BS - Empleador/a") %>% 
  ggplot(aes(PP00_pago_dia, DL18_discriminacion_oficio))+
  geom_boxplot(color = "cyan4") +
  scale_x_continuous(labels = scales::dollar_format(),
                     breaks = scales::pretty_breaks(n = 6))+
  geom_vline(xintercept = mean(A3_Base_FInal$PP00_pago_dia,na.rm = T),
             color = "brown",lty = 2)+
  stat_summary(fun.x = mean, geom = "point",
               shape = 20, size = 4, color = "cyan3")+
  labs(title = "?Cu?l es el 'pago justo' por un d?a trabajo dom?stico?",
       x = "Pesos colombianos-COP",y ="",
       caption = "[---] Promedio general")+
  theme_minimal()+
  theme(text = element_text(family = "serif"),
        plot.title = element_text(hjust = 0.5))

# APENDICE ----

## 1. Loop para extraer Var.names de encuestas----

# var.Names <- data.frame("index" = numeric(),
#                         "variable" = character(),
#                         "tipo" = character())
# 
# for (i in 1:ncol(A1_encuestas)) {
#   pr1 <- data.frame(
#     "index" = i,
#     "Codigo" = gsub(":","",(stringr::str_extract(names(A1_encuestas)[i],".*:"))),
#     "variable" = as.character(names(A1_encuestas)[i]),
#     "tipo" = as.character(class(A1_encuestas[,i])),
#     "Completitud" = mean(!is.na(A1_encuestas[,i]))) 
# 
#   var.Names <- rbind(var.Names,pr1)
#   rm(pr1)
# }



