# Reporte
library(dplyr)
library(tidyr)
library(googlesheets4)
library(stringr)
library(ggplot2)
options(scipen =  1000)

# 0. load information ----

## 0.1. Informed consent ----
a0_students_consent <-
  read_sheet("https://docs.google.com/spreadsheets/d/1ln3AgV-08vaP1RKeRtaXzqIk8jQuC0fR2OXuyFBMt4M/edit?usp=sharing") %>% 
  as.data.frame() %>%  rename(ID_estudiante = Número) %>% 
  mutate(ID_estudiante = as.character(ID_estudiante))

## 0.2. Data dictionary 
b0_dictionary <- read.csv(
  "00_basic_data/0. Diccionario de variables.csv",
  header = T)

## 0.2. Surveys ----
c0_raw_sourvey <- read_sheet("https://docs.google.com/spreadsheets/d/12Y2I-DBsfwJPKXRQvZ730ALZKfv2OcQjI8dxisFHxqY/edit?usp=sharing") %>% 
  # Initial editions
  mutate(Timestamp = as.Date(as.character(Timestamp))) %>% 
  select(-82,-93,-107,-114,-118,-122,-123,-146,-158,-162,-163,-164,-165,-166,-167) %>% 
  mutate(across(c(3,5,7,23,25,33,42,86,87,93,114,117,118,137),~as.character(.))) %>% 
  as.data.frame() %>% 
  # Correcting formats
  mutate(across(c(13,14,115),~as.character(.)),
         across(c(16,119),~as.Date(.)))
# renaming variables
names(b0_raw_sourvey) <- a0_dictionary[,2]




# DATA CLIANING -----


# 1. Informed concent ----

a1_students_consent <- a0_students_consent %>% 
  select(Timestamp,
        id_student = ID_estudiante,
        q1 = `Manifiesto que _______ participar de manear voluntaria en el ejercicio de recolección de encuestas del proyecto en cuestión`,
        q2 = `Del mismo modo, reconozco que _________ recibí una capacitación por parte del equipo investigador, sobre la voluntariedad de las personas a encuestar por participar en la encuesta, la reserva de datos sensibles y sobre la importancia ética de no encuestar personas directamente subordinadas a mi o a mi núcleo familiar, de manera laboral o económica.`,
        q3 = `Por otro lado, expreso que (de ser posible) ___________ interés en ser coautor/a de la base de datos recolectada en este ejercicio, como un producto académico/científico público, independiente de las públicaciones que con ella se hagan.`,
        q4 = `Señalo tambien, que el grupo investigador _______ en cuanto al carácter voluntario de este ejercicio y el alcance del mismo.`,
        q5 = `Finalmente, ____________  a manejar todos los datos reportados por l@s encuestad@s en estricta confidencialidad, bajo la reserva del ejercicio de investigación y en cumplimiento con las directrices legales e institucionales de protección de datos.`) %>% 
  pivot_longer(cols = 3:7,
               names_to = "q") %>% 
  mutate(
    value = str_detect(tolower(value),"no")==F,
    q_description = case_when(
      q=="q1"~"Q1. Wants to participate voluntarly",
      q=="q2"~"Q2. Claims to have received training",
      q=="q3"~"Q3. Wants to recive credit for\nthe data collection",
      q=="q4"~"Q4. Claims that the researchers\nwere clear regarding the voluntary\nnature of the exercise",
      T~"Q5. Agrees to keep the confidentiality\nof the data collected")) %>% 
  merge(
    (.[] %>% 
       filter(q != "q3") %>% 
       group_by(id_student) %>% 
       summarise(collection_agreement = mean(value)==1)),
    by = "id_student") %>% 
  select(Timestamp, id_student, collection_agreement, q, q_description, value) %>% 
  mutate(value = ifelse(value ==T,"Yes","No"))


a1_students_consent %>% 
  group_by(q_description,value) %>% 
  summarise(n = n()) %>% 
  group_by(q_description) %>%
  mutate(tot = sum(n)) %>% 
  # Plot
  ggplot(aes(n,q_description, fill = value)) + 
  geom_bar(stat = "identity", alpha = .8)+
  geom_text(aes(n,q_description,label =n))+
  scale_fill_manual(values = c("firebrick3","deepskyblue4"))+
  theme_minimal()+
  theme(text = element_text(family = "serif"),
        legend.position = "bottom")



data.frame(
  g = LETTERS[1:5],
  val = rep(5,5)) %>% 
  ggplot(aes(g,val, color = g))+
  geom_point(size = 30)+
  theme_minimal()+
  theme(legend.position = "none",
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y.left = element_blank())+
  scale_color_manual(
    values = 
      c("lightskyblue2","lightskyblue3","deepskyblue4",
        "firebrick3","firebrick4"))


# 1. Data dictionary ----

## 1.1. Detect variables by respondent type
z0_test <- b0_raw_sourvey %>% 
  group_by(TI01_tipo) %>% 
  summarise(across(everything(),~mean(!is.na(.)))) %>% 
  reshape2::melt(id.vars = "TI01_tipo") %>% 
  group_by(TI01_tipo) %>% 
  mutate(index = row_number(),
         index = ifelse(index >=8,index+1,index),
         value = ifelse(
           value>0.1,paste0(
             "x (", round(value,2),")"),"")) %>% 
  pivot_wider(id_cols = c(index,variable),
              names_from = TI01_tipo,
              values_from = value)

## 1.2. Add information to the dictionary
z1_dictionary

# Preparing DATA repository (google drive)

## .1. Preparing data-lake (sheets/tables)
googlesheets4::sheet_add(
  ss = cooked_data, 
  sheet = "00_data_dictionary")

googlesheets4::sheet_add(
  ss = cooked_data, 
  sheet = "01_raw_data")

googlesheets4::sheet_add(
  ss = cooked_data, 
  sheet = "02_workers")

googlesheets4::sheet_add(
  ss = cooked_data, 
  sheet = "03_employers")

## 2. Writing data
googlesheets4::write_sheet(
  data = z1_dictionary,
  ss = cooked_data,
  sheet = "00_data_dictionary")













