# 1. Re-stablish classes

a1_workers <- a0_raw_sourvey %>% 
  #filter(TI01_tipo != "BS - Empleador/a") %>% 
  select(TI01_tipo, ID_estudiante, ID_trabajador,ID_trabajador_R,
         starts_with(c("CC","DL")))


a1_workers %>%
  select(ID_trabajador,TI01_tipo,starts_with("CC")) %>% 
  reshape2::melt(id.vars = c("ID_trabajador","TI01_tipo")) %>% 
  mutate(value = case_when(
    str_detect(value,"00")==T~"0. Desconocimiento",
    str_detect(value,"02")==T~"1. Subestimación",
    str_detect(value,"01")==T~"3. Conocimiento",
    T~"2. Sobrestimación",
  )) %>% 
  group_by(TI01_tipo,variable,value) %>%
  summarise(n = n()) %>% 
  mutate(order = ifelse(value == "3. Conocimiento",n,0)) %>% 
  
  arrange(desc(value)) %>% 
  group_by(variable) %>% 
  mutate(place = cumsum(n),
         place = (n-n)+(n/2)) %>% 
  # Plot
  ggplot(aes(n, reorder(variable,order,max), fill = value))+
  geom_bar(stat = "identity", alpha =.9)+
  
  # geom_text(aes(y = place,label = paste0(round((n*100),2),"%")),
  #           family="serif",color = "white")+
  # 
  
  scale_fill_manual(values = c("grey20","orange","red4","cyan4"))+
  theme_minimal()+
  theme(text = element_text(family = "serif"))+
  facet_wrap(.~TI01_tipo,scales = "free")

a2_workers <- a1_workers %>% 
  mutate(across(
    CC01_lic_maternidad:CC14_sindicato_B,
    ~ifelse(str_detect(.,"01")==T,1,0)))

table(a0_raw_sourvey$TI01_tipo)