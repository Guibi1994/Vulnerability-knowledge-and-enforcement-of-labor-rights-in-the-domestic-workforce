---
title: ""
output: pdf_document
---

```{r, message=FALSE, warning=FALSE,echo=FALSE}
library(dplyr)
library(googlesheets4)
library(stringr)
library(stargazer)
```

```{r, message=FALSE,echo=FALSE,warning=FALSE}


## 0.1. Surveys ----
a0_raw_sourvey <- read_sheet("https://docs.google.com/spreadsheets/d/12Y2I-DBsfwJPKXRQvZ730ALZKfv2OcQjI8dxisFHxqY/edit?usp=sharing") %>% 
  # Initial editions
  mutate(Timestamp = as.Date(as.character(Timestamp))) %>% 
  select(-82,-93,-107,-114,-118,-122,-123,-146,-158,-162,-163,-164,-165,-166,-167) %>% 
  mutate(across(c(3,5,7,23,25,33,42,86,87,93,114,117,118,137),~as.character(.))) 

# renaming variables
names(a0_raw_sourvey) <- read.csv(
  "../00_basic_data/0. Diccionario de variables.csv",
  header = T)[,2]


## 0.2. Informed consent ----
b0_raw_consent <-
  read_sheet("https://docs.google.com/spreadsheets/d/1ln3AgV-08vaP1RKeRtaXzqIk8jQuC0fR2OXuyFBMt4M/edit?usp=sharing") %>% 
  as.data.frame() %>%  rename(ID_estudiante = NÃºmero) %>% 
  mutate(ID_estudiante = as.character(ID_estudiante))





# 1. Separate cohorts ----
## 1.1. First round ----
a11_old <- a0_raw_sourvey %>% filter(Fecha_captura < as.Date("2022-08-10")) %>% 
  mutate(across(1:ncol(a0_raw_sourvey),~as.character(.))) %>% 
  select(ID_estudiante,estu_nombre,estu_apellidos,estu_clase,TI01_tipo,
         ID_trabajador,ID_trabajador_R,ID_empleador,ID_subordinado,ID_subordinado_R)

## 1.2. Second round ----
a12_new <- a0_raw_sourvey %>% filter(Fecha_captura >= as.Date("2022-08-10")) %>%
  mutate(across(1:ncol(a0_raw_sourvey),~as.character(.))) %>% 
  select(ID_estudiante,estu_nombre,estu_apellidos,estu_clase,TI01_tipo,
         ID_trabajador,ID_trabajador_R,ID_empleador,ID_subordinado,ID_subordinado_R)








# 2. Separate suorveys

# Estudiante-Trabajador
b1_estudiante_trabajador <- a12_new %>% 
  filter(TI01_tipo != "BS - Empleador/a") %>% 
  select(ID_estudiante, estu_clase, ID_trabajador, ID_trabajador_R) %>% 
  # Iguales
  mutate(id_R_igual = ifelse(ID_trabajador == ID_trabajador_R,T,F))
  

b2_estudiante_empleador <- a12_new %>% 
  filter(TI01_tipo == "BS - Empleador/a") %>% 
  select(ID_estudiante, estu_clase,ID_empleador, ID_subordinado, ID_subordinado_R) %>% 
  # Iguales
  mutate(id_R_igual = ifelse(ID_subordinado == ID_subordinado_R,T,F))


# 3. Curce de bases



c1_reporte_final <- 
  # Resumen de la base de trabajadores
  b1_estudiante_trabajador %>% 
  mutate(Homologo = 
           ifelse(ID_trabajador %in% b2_estudiante_empleador$ID_subordinado,1,0)) %>% 
  group_by(clase = estu_clase, ID_estudiante) %>% 
  summarise(encustas_trabajadores = n(),
            encuestas_trabajadores_homologas = sum(Homologo))  %>% 
  # Merge con la base de empleadores
  merge(
    (b2_estudiante_empleador %>% 
    mutate(Homologo = 
              ifelse(ID_subordinado %in% b1_estudiante_trabajador$ID_trabajador,1,0)) %>% 
       group_by(clase = estu_clase, ID_estudiante) %>% 
       summarise(encustas_empleadores = n(),
                 encuestas_empleadores_homologas = sum(Homologo))), 
    by = c("clase", "ID_estudiante"), all = T) %>% 
  # Metricas adicionales
  
  mutate(across(1:ncol(.),~ifelse(is.na(.),0,.)), #,
         Total.validas = encuestas_empleadores_homologas+           encuestas_trabajadores_homologas,
         Firmo.consentimiento.informado = 
           ifelse(ID_estudiante %in% b0_raw_consent$ID_estudiante,T,F),
         Nota.Final = 
           round(
           ((Total.validas/6*5)*Firmo.consentimiento.informado),2)) %>% 
  rename(ID = ID_estudiante, 
         Trabajador = encustas_trabajadores,
         Trabador.homologo = encuestas_trabajadores_homologas,
         Empleador = encustas_empleadores,
         Empleador.homologo = encuestas_empleadores_homologas,
         Firmo.CI = Firmo.consentimiento.informado) %>% 
  mutate(clase = str_replace_all(clase,"Derecho\\s|de\\sla\\s",""))


```

```{r, results='asis',warning=FALSE,message=FALSE, echo=FALSE}
stargazer::stargazer(c1_reporte_final, summary = F, header = F, rownames = F,
                     title = paste0("Reporte al ",Sys.Date()), font.size = "tiny",
                     digits = 2)
```
